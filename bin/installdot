#!/usr/bin/env ruby

require 'pathname'
require 'optparse'


def install_dot(target, link_name, options = {})
  unless target.exist?
    warn("#{target} doen't exist")
    return
  end

  if link_name.symlink? && link_name.readlink == target
    return # Already installed, silently ignored.

  elsif link_name.exist? || link_name.symlink? # may be a broken link
    if options[:force]
      link_name.delete
    else
      warn("#{link_name} already exists")
      return
    end
  end

  link_name.make_symlink(target)
end

def parse_options
  options = {}
  parser = OptionParser.new do |opts|
    opts.banner = "Usage: #{opts.program_name} [-f] DOTFILE ..."
    opts.on('-f', 'Force install') { options[:force] = true }
  end
  parser.parse!
  options
end


options = parse_options
abort('missing dotfile') if ARGV.empty?

home_dir = Pathname.new('~').expand_path
dotfile_names = ARGV.map { |a| Pathname.new(a) }

dotfile_names.each do |name|
  target = home_dir.join('dotfiles', name)
  link_name = home_dir.join(name)
  install_dot(target, link_name, options)
end

